name: Production Backend Deploy

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via Bastion to Private WAS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PUBLIC_HOST }}
          username: ${{ secrets.PUBLIC_USER }}
          key: ${{ secrets.PUBLIC_SSH_KEY }}
          script: |
            set -e

            echo "Connecting to Private WAS..."

            ssh -o StrictHostKeyChecking=no ubuntu@10.10.10.6 << 'EOF'
              set -e

              echo "Moving to app directory..."
              cd /home/ubuntu/ChannelAI_practice

              echo "Resetting to latest main..."
              git fetch --all
              git reset --hard origin/main

              echo "Installing dependencies..."
              npm ci

              echo "Reloading PM2..."
              pm2 reload channelai || pm2 start server.js --name channelai

              pm2 save

              echo "Deployment complete."
            EOF